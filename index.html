<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EPS Market + Eí†¡</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
/* ğŸ”¹ ì „ì²´ ë°°ê²½ */
body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  margin:0; 
  background: linear-gradient(120deg,#f0f0f0,#e0e0e0); 
  color:#333; 
}
/* ğŸ”¹ í—¤ë” */
header { 
  background: linear-gradient(90deg, #4CAF50, #66BB6A); 
  color:white; 
  padding:2rem; 
  text-align:center; 
  box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
  border-bottom:3px solid #2e7d32; 
  font-size:2rem; 
  letter-spacing:2px; 
  text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
}
/* ğŸ”¹ ì»¨í…Œì´ë„ˆ */
.container { 
  padding:2rem; 
  max-width:1200px; 
  margin:auto; 
}
/* ğŸ”¹ ìƒí’ˆ ì¹´ë“œ */
.product { 
  background:white; 
  padding:1rem; 
  margin:1rem; 
  display:inline-block; 
  width:220px; 
  text-align:center; 
  border-radius:16px; 
  box-shadow:0 4px 10px rgba(0,0,0,0.2); 
  transition: transform 0.3s, box-shadow 0.3s; 
}
.product:hover { 
  transform: translateY(-5px) scale(1.05); 
  box-shadow:0 8px 20px rgba(0,0,0,0.3); 
}
/* ğŸ”¹ ìƒí’ˆ ì´ë¯¸ì§€ */
.product img { 
  width:100%; 
  border-radius:12px; 
  border:2px solid #4CAF50; 
  box-shadow: inset 0 0 10px rgba(0,0,0,0.1); 
}
/* ğŸ”¹ ë²„íŠ¼ */
button { 
  margin-top:0.5rem; 
  background: linear-gradient(90deg,#4CAF50,#66BB6A); 
  color:white; 
  border:none; 
  padding:0.6rem 1.2rem; 
  border-radius:12px; 
  cursor:pointer; 
  font-weight:bold; 
  letter-spacing:1px; 
  box-shadow:0 4px 8px rgba(0,0,0,0.2); 
  transition: all 0.3s; 
}
button:hover { 
  background: linear-gradient(90deg,#66BB6A,#4CAF50); 
  transform: scale(1.05); 
  box-shadow:0 6px 12px rgba(0,0,0,0.3); 
}
/* ğŸ”¹ ì…ë ¥ì°½ */
input { 
  margin:0.3rem; 
  padding:0.6rem; 
  border-radius:8px; 
  border:2px solid #ccc; 
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); 
  transition: border 0.3s, box-shadow 0.3s; 
}
input:focus { 
  border:2px solid #4CAF50; 
  box-shadow:0 0 6px #4CAF50; 
  outline:none; 
}
/* ğŸ”¹ ì±„íŒ…ì°½ */
.chat-container { 
  border:2px solid #4CAF50; 
  border-radius:16px; 
  background:white; 
  width:100%; 
  max-width:600px; 
  padding:1rem; 
  margin:2rem auto; 
  box-shadow:0 4px 12px rgba(0,0,0,0.2); 
  display:flex; 
  flex-direction:column; 
  max-height:400px; 
  overflow-y:auto; 
}
.chat-message { 
  padding:0.5rem 1rem; 
  margin:0.3rem 0; 
  border-radius:12px; 
  max-width:70%; 
  word-wrap:break-word; 
  box-shadow:0 2px 4px rgba(0,0,0,0.1); 
  animation: fadeIn 0.3s ease-in; 
}
.chat-message.user { 
  background:#4CAF50; 
  color:white; 
  align-self:flex-end; 
}
.chat-message.partner { 
  background:#E0E0E0; 
  color:#333; 
  align-self:flex-start; 
}
@keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
/* ğŸ”¹ ì±„íŒ… ì…ë ¥ì°½ */
.chat-input { 
  display:flex; 
  margin-top:0.5rem; 
}
.chat-input input { 
  flex:1; 
}
</style>
</head>
<body>

<header>ğŸ”¥ EPS Market + Eí†¡ ğŸ”¥</header>

<div class="container" id="authContainer">
  <h2>ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h2>
  <input type="email" id="email" placeholder="ì´ë©”ì¼">
  <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
  <button id="signupBtn">íšŒì›ê°€ì…</button>
  <button id="loginBtn">ë¡œê·¸ì¸</button>
</div>

<div class="container" id="storeContainer" style="display:none;">
  <h2>ìƒí’ˆ ëª©ë¡</h2>
  <div id="products"></div>

  <h3>ìƒí’ˆ ì¶”ê°€</h3>
  <input type="text" id="productName" placeholder="ìƒí’ˆëª…">
  <input type="number" id="productPrice" placeholder="ê°€ê²©">
  <input type="text" id="productImage" placeholder="ì´ë¯¸ì§€ URL">
  <button id="addProductBtn">ì¶”ê°€</button>

  <h3>ë‚´ ì½”ì¸: <span id="myCoin">0</span></h3>
  <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>

  <div id="chatSection"></div>
</div>

<script>
  // ğŸ”¹ Firebase ì„¤ì • (ì œê³µí•´ì£¼ì‹  ê°’ ì ìš©)
  const firebaseConfig = {
    apiKey: "AIzaSyAus-wBYUVjjzGb1XnBhjKObDw2t_-C_98",
    authDomain: "eps-market.firebaseapp.com",
    projectId: "eps-market",
    storageBucket: "eps-market.firebasestorage.app",
    messagingSenderId: "974829100466",
    appId: "1:974829100466:web:98cf87f84f0b7100b818ab"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const authContainer = document.getElementById("authContainer");
  const storeContainer = document.getElementById("storeContainer");
  const productsDiv = document.getElementById("products");
  const myCoinSpan = document.getElementById("myCoin");
  const chatSection = document.getElementById("chatSection");

  let currentUser = null;

  // ğŸ”¹ íšŒì›ê°€ì…
  document.getElementById("signupBtn").addEventListener("click", async ()=>{
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    if(!email||!password) return alert("ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥");
    const query = await db.collection("users").where("email","==",email).get();
    if(!query.empty) return alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼");
    const userRef = await db.collection("users").add({email,password,createdAt:new Date()});
    await db.collection("coin").doc(userRef.id).set({balance:10000});
    alert("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”");
  });

  // ğŸ”¹ ë¡œê·¸ì¸
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const query = await db.collection("users").where("email","==",email).where("password","==",password).get();
    if(query.empty) return alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
    currentUser = {id: query.docs[0].id, email};
    authContainer.style.display="none";
    storeContainer.style.display="block";
    loadCoin();
    loadProducts();
  });

  // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ
  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    currentUser=null;
    authContainer.style.display="block";
    storeContainer.style.display="none";
    productsDiv.innerHTML="";
    chatSection.innerHTML="";
  });

  // ğŸ”¹ ì½”ì¸ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadCoin(){
    const doc = await db.collection("coin").doc(currentUser.id).get();
    myCoinSpan.textContent=doc.exists?doc.data().balance:0;
  }

  // ğŸ”¹ ìƒí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadProducts(){
    productsDiv.innerHTML="";
    const snapshot = await db.collection("products").get();
    snapshot.forEach(doc=>{
      const product = doc.data();
      const div = document.createElement("div");
      div.className="product";
      div.innerHTML=`
        <img src="${product.image}" alt="${product.name}">
        <h3>${product.name}</h3>
        <p>â‚©${product.price}</p>
        <button onclick="buyProduct('${doc.id}',${product.price},'${product.ownerId}')">êµ¬ë§¤ / Eí†¡</button>
      `;
      productsDiv.appendChild(div);
    });
  }

  // ğŸ”¹ ìƒí’ˆ ì¶”ê°€
  document.getElementById("addProductBtn").addEventListener("click", async ()=>{
    const name=document.getElementById("productName").value;
    const price=Number(document.getElementById("productPrice").value);
    const image=document.getElementById("productImage").value;
    if(!name||!price||!image) return alert("ëª¨ë“  í•­ëª© ì…ë ¥");
    await db.collection("products").add({name,price,image,ownerId:currentUser.id});
    loadProducts();
  });

  // ğŸ”¹ êµ¬ë§¤ + Eí†¡
  async function buyProduct(productId,price,ownerId){
    if(ownerId===currentUser.id) return alert("ìê¸° ìƒí’ˆì€ êµ¬ë§¤ ë¶ˆê°€");
    const coinRef=db.collection("coin").doc(currentUser.id);
    const doc = await coinRef.get();
    const balance=doc.data()?.balance||0;
    if(balance<price) return alert("ì”ì•¡ ë¶€ì¡±");
    await coinRef.update({balance:balance-price});
    await db.collection("buy").add({userId:currentUser.id,productId,timestamp:new Date()});
    alert("êµ¬ë§¤ ì™„ë£Œ!");
    loadCoin();
    openChat(ownerId,productId);
  }

  // ğŸ”¹ 1:1 ì±„íŒ…
  async function openChat(partnerId,productId){
    chatSection.innerHTML="";
    const chatId=[currentUser.id,partnerId,productId].sort().join("_");
    const chatRef=db.collection("chats").doc(chatId);
    const chatDoc = await chatRef.get();
    if(!chatDoc.exists) await chatRef.set({participants:[currentUser.id,partnerId],productId,messages:[]});
    const chatContainer=document.createElement("div");
    chatContainer.className="chat-container";
    const chatInputDiv=document.createElement("div");
    chatInputDiv.className="chat-input";
    const inputEl=document.createElement("input");
    inputEl.placeholder="ë©”ì‹œì§€ ì…ë ¥...";
    const sendBtn=document.createElement("button");
    sendBtn.textContent="ì „ì†¡";
    chatInputDiv.append(inputEl,sendBtn);
    chatSection.append(chatContainer,chatInputDiv);

    chatRef.onSnapshot(doc=>{
      chatContainer.innerHTML="";
      const msgs=doc.data().messages||[];
      msgs.forEach(msg=>{
        const msgDiv=document.createElement("div");
        msgDiv.className="chat-message "+(msg.sender===currentUser.id?"user":"partner");
        msgDiv.textContent=msg.text;
        chatContainer.appendChild(msgDiv);
        chatContainer.scrollTop=chatContainer.scrollHeight;
      });
    });

    sendBtn.onclick=async ()=>{
      const text=inputEl.value.trim();
      if(!text) return;
      await chatRef.update({messages:firebase.firestore.FieldValue.arrayUnion({sender:currentUser.id,text,timestamp:new Date()})});
      inputEl.value="";
    }
  }
</script>

</body>
</html>
